# 一星球多空间站实现方案计划书

## 一、现状分析

### 1.1 disintegration当前实现限制
- **一星球一单空间站**：使用`DTVars.spaceStationPlanets.contains(planet)`检查是否已存在
- **命名限制**：空间站名称格式为`parent.name + "-space-station"`
- **持久化限制**：只存储行星名称，无法区分多个空间站
- **UI限制**：发射台配置界面只能选择行星，无法选择具体的空间站

### 1.2 核心数据结构
```java
// 当前限制的核心
Seq<Planet> spaceStationPlanets;  // 只存行星
Seq<SpaceStation> spaceStations;   // 存空间站对象
```

---

## 二、方案设计

### 2.1 数据结构改造

#### 2.1.1 创建空间站信息类
```java
public class SpaceStationInfo {
    public String id;           // 唯一标识符
    public Planet parent;       // 父行星
    public String name;         // 空间站名称
    public long createTime;     // 创建时间
    public int stationNumber;   // 该行星上的编号
}
```

#### 2.1.2 重构全局变量
```java
// 替换原有的两个Seq
Seq<SpaceStationInfo> spaceStationInfos;  // 存储所有空间站信息
ObjectMap<String, SpaceStation> spaceStationMap;  // ID到空间站对象的映射
```

### 2.2 核心类改造

#### 2.2.1 SpaceStation.java 改造
- **支持自定义名称**：不再固定命名
- **存储ID**：在空间站对象中保存唯一ID
- **添加编号**：记录该空间站在父行星上的序号

#### 2.2.2 SpaceStationIO.java 改造
- **新的持久化格式**：
  ```
  planetName|stationId|stationName|createTime|stationNumber
  planetName|stationId|stationName|createTime|stationNumber
  ```
- **支持读取和写入多个空间站**

#### 2.2.3 SpaceStationLaunchPad.java 改造
- **UI重构**：
  - 行星选择 → 空间站选择界面
  - 显示该行星已有的空间站列表
  - 支持创建新空间站或查看已有空间站
- **创建逻辑**：
  - 自动生成唯一ID
  - 自动分配序号
  - 支持自定义空间站名称
- **发射逻辑**：
  - 不再检查行星是否已有空间站
  - 检查用户选择的操作（新建/选择）

### 2.3 新增功能模块

#### 2.3.1 空间站管理对话框
```java
public class SpaceStationManagerDialog extends BaseDialog {
    // 显示所有空间站
    // 支持重命名
    // 支持删除（带确认）
    // 支持跳转
}
```

#### 2.3.2 空间站选择对话框
```java
public class SpaceStationSelectDialog extends BaseDialog {
    // 按行星分组显示
    // 显示空间站信息（名称、创建时间等）
    // 支持搜索
}
```

#### 2.3.3 空间站创建对话框
```java
public class SpaceStationCreateDialog extends BaseDialog {
    // 选择目标行星
    // 输入空间站名称
    // 显示预览信息
    // 确认创建
}
```

### 2.4 命名方案

#### 2.4.1 自动命名规则
- **默认名称**：`{行星名} 空间站 #{编号}`
- **示例**：
  - `Erekir 空间站 #1`
  - `Erekir 空间站 #2`
  - `Serpulo 空间站 #1`

#### 2.4.2 唯一ID生成
- **格式**：`{行星名}-station-{时间戳}`
- **示例**：`erekir-station-1708000000000`

---

## 三、实现步骤

### 阶段一：基础数据结构改造
1. 创建`SpaceStationInfo`类
2. 重构`DTVars.java`，替换原有数据结构
3. 更新`SpaceStation.java`，添加ID和编号字段

### 阶段二：持久化系统改造
1. 重构`SpaceStationIO.java`，实现新的读写格式
2. 编写数据迁移逻辑（从旧格式迁移到新格式）
3. 测试持久化功能

### 阶段三：UI/UX改造
1. 创建`SpaceStationManagerDialog`
2. 创建`SpaceStationSelectDialog`
3. 创建`SpaceStationCreateDialog`
4. 重构`SpaceStationLaunchPad.java`的配置界面
5. 优化用户体验

### 阶段四：核心逻辑改造
1. 更新`SpaceStation.create()`方法
2. 添加创建多个空间站的逻辑
3. 更新发射台的发射逻辑
4. 添加空间站管理功能

### 阶段五：测试和优化
1. 全面功能测试
2. 性能优化
3. Bug修复
4. 用户体验优化

---

## 四、文件清单

### 新增文件
1. `tqlslib/type/SpaceStationInfo.java` - 空间站信息类
2. `tqlslib/ui/dialogs/SpaceStationManagerDialog.java` - 空间站管理对话框
3. `tqlslib/ui/dialogs/SpaceStationSelectDialog.java` - 空间站选择对话框
4. `tqlslib/ui/dialogs/SpaceStationCreateDialog.java` - 空间站创建对话框

### 修改文件
1. `tqlslib/DTVars.java` - 数据结构重构
2. `tqlslib/type/SpaceStation.java` - 添加ID和编号支持
3. `tqlslib/core/SpaceStationIO.java` - 持久化格式改造
4. `tqlslib/world/blocks/campaign/SpaceStationLaunchPad.java` - UI和逻辑重构
5. `tqlslib/TQLSlib.java` - 初始化新功能

---

## 五、技术亮点

1. **向后兼容**：自动迁移旧数据
2. **扩展性强**：易于添加新功能
3. **用户友好**：直观的UI设计
4. **性能优化**：使用ObjectMap提高查找效率
5. **错误处理**：完善的异常处理和日志记录

---

## 六、风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 数据迁移失败 | 高 | 低 | 备份旧数据，提供回滚机制 |
| 性能问题 | 中 | 低 | 使用高效的数据结构，优化查询 |
| UI复杂度增加 | 中 | 中 | 分阶段实现，提供简洁模式 |
| 兼容性问题 | 高 | 低 | 充分测试，保持API兼容 |

---

## 七、预期成果

- ✅ 支持在单个行星上创建多个空间站
- ✅ 每个空间站有独立的名称和ID
- ✅ 完整的空间站管理功能（创建、重命名、删除、跳转）
- ✅ 向后兼容现有存档
- ✅ 优秀的用户体验